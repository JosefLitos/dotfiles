#!/usr/bin/bash
# simpler=faster xdg-open replacement

[[ $1 == -c ]] && CFG=$2 && shift 2 || CFG=${XDG_CONFIG_HOME:-$HOME/.config}/open.conf.sh
[[ $1 == file://* ]] && arg=$(echo -n "${1#file://}" | urlencode -d) || arg=("$@")
URI=${arg/:*/:} && [[ $arg == *.* ]] && EXT=.${arg##*.} || EXT=.

run() {
	[[ -e $arg && $arg != /* ]] && for ((i = ${#arg[@]} - 1; i >= 0; i--)); do
		arg[$i]="$PWD/${arg[$i]}"
	done
	local cmd=$1
	[[ $cmd == @* || ${BLOCKING:-$TERM_BLOCKING} == 1 && -t 0 && -t 1 && -t 2 ]] ||
		cmd="${TERMINAL:-xterm} $cmd"
	[[ $BLOCKING == 1 || $cmd != @* && $TERM_BLOCKING == 1 ]] &&
		${cmd#@} "${arg[@]}" || { ${cmd#@} "${arg[@]}" & }
	exit 0
}

# prefix gui/bg apps with '@', $1=cmd TODO: separate bg+gui opts per item or global?
try() {
	local app="$1"
	shift
	while (($#)); do
		if [[ $1 == .* ]]; then
			[[ $EXT == $1 ]] && run "$app"
		elif [[ $1 == +* ]]; then
			[[ ${MIME:=$(file -b --mime-type "$arg")} == ${1#+}* ]] && run "$app"
		elif [[ $1 == *: ]]; then
			[[ $URI == $1 ]] && run "$app"
		elif [[ $arg =~ $1 ]]; then
			run "$app"
		fi
		shift
	done
}

[[ -f $CFG ]] && . "$CFG"

[[ -d $arg ]] && run "${EXPLORER:-ranger}"
[[ -f $arg ]] && try "$EDITOR" . +text +*empty +*json
run "$BROWSER"
